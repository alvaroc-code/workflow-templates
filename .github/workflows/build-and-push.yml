name: Reusable Build and Release

on:
  workflow_call:
    inputs:
      registry:
        description: 'Container registry URL'
        required: false
        type: string
        default: 'ghcr.io'
      image_name:
        description: 'Image name (defaults to repository name)'
        required: false
        type: string
        default: ''
      dockerfile_path:
        description: 'Path to Dockerfile'
        required: false
        type: string
        default: './Dockerfile'
      build_context:
        description: 'Build context path'
        required: false
        type: string
        default: '.'
      version_prefix:
        description: 'Version prefix (e.g., v, app-v)'
        required: false
        type: string
        default: 'v'
    secrets:
      registry_username:
        description: 'Registry username'
        required: false
      registry_password:
        description: 'Registry password'
        required: false

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      image_tag_versioned: ${{ steps.version.outputs.image_tag_versioned }}
      image_tag_latest: ${{ steps.version.outputs.image_tag_latest }}
      image_tag_sha: ${{ steps.version.outputs.image_tag_sha }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Determine version
        id: version
        run: |
          PREFIX="${{ inputs.version_prefix }}"
          IMAGE_NAME="${{ inputs.image_name }}"
          if [ -z "$IMAGE_NAME" ]; then
            IMAGE_NAME="${{ github.repository }}"
          fi
          
          if git tag --list | grep -q "${PREFIX}[0-9]*\.[0-9]*\.[0-9]*"; then
            LATEST_TAG=$(git describe --tags --abbrev=0 --match "${PREFIX}*" 2>/dev/null)
            if [ -n "$LATEST_TAG" ]; then
              VERSION_PART=$(echo $LATEST_TAG | sed "s/${PREFIX}//")
              MAJOR=$(echo $VERSION_PART | cut -d. -f1)
              MINOR=$(echo $VERSION_PART | cut -d. -f2)
              PATCH=$(echo $VERSION_PART | cut -d. -f3)
              NEW_PATCH=$((PATCH + 1))
              NEW_VERSION="${PREFIX}${MAJOR}.${MINOR}.${NEW_PATCH}"
            else
              NEW_VERSION="${PREFIX}0.1.0"
            fi
          else
            NEW_VERSION="${PREFIX}0.1.0"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "image_tag_versioned=${{ inputs.registry }}/${IMAGE_NAME}:$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "image_tag_latest=${{ inputs.registry }}/${IMAGE_NAME}:latest" >> $GITHUB_OUTPUT
          echo "image_tag_sha=${{ inputs.registry }}/${IMAGE_NAME}:${{ github.sha }}" >> $GITHUB_OUTPUT

  build_and_push:
    runs-on: ubuntu-latest
    needs: version
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry }}
          username: ${{ secrets.registry_username || github.actor }}
          password: ${{ secrets.registry_password || secrets.GITHUB_TOKEN }}

      - name: Build and push Docker images
        run: |
          docker build \
            -f "${{ inputs.dockerfile_path }}" \
            -t "${{ needs.version.outputs.image_tag_versioned }}" \
            -t "${{ needs.version.outputs.image_tag_latest }}" \
            -t "${{ needs.version.outputs.image_tag_sha }}" \
            "${{ inputs.build_context }}"
          docker push "${{ needs.version.outputs.image_tag_versioned }}"
          docker push "${{ needs.version.outputs.image_tag_latest }}"
          docker push "${{ needs.version.outputs.image_tag_sha }}"

  tag_release:
    runs-on: ubuntu-latest
    needs: [version, build_and_push]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push git tag
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "GitHub Actions"
          echo "Creating git tag: ${{ needs.version.outputs.new_version }}"
          git tag -a "${{ needs.version.outputs.new_version }}" -m "Release ${{ needs.version.outputs.new_version }} [skip ci]"
          git push origin "${{ needs.version.outputs.new_version }}"
